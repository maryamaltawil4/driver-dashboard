<div class="container py-5">
    <!-- Dashboard Header -->
    <div class="row align-items-end mb-4">
      <div class="col-md-8">
        <h1 class="h3 fw-bold text-dark">Driver Performance</h1>
        <p class="text-muted mb-0">Track and analyze your delivery team's efficiency</p>
      </div>
      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <div class="btn-group bg-light rounded-pill p-1">
          <button *ngFor="let r of ['30d', '60d', '90d', 'ytd']" (click)="selectRange(r)" type="button"
            class="btn btn-sm rounded-pill"
            [ngClass]="{ 'btn-light text-primary shadow-sm': selectedRange === r, 'btn-link text-secondary': selectedRange !== r }">
            {{ r.toUpperCase() }}
          </button>
        </div>
      </div>
    </div>
  
    <!-- Driver Profile Summary -->
    <div class="card mb-4" *ngIf="selectedDriverId">
      <div class="card-body">
        <ng-container *ngIf="selectedDriverId">
          <ng-container *ngFor="let d of driverKpiHistory">
            <ng-container *ngIf="d.id === selectedDriverId">
              <h5>{{ d.fullName }}</h5>
              <p>
                Phone: {{ d.contactInfo.phone }}<br />
                Email: {{ d.contactInfo.email }}<br />
                Experience: {{ d.yearsOfExperience }} years<br />
                License: {{ d.license.type }} (expires {{ d.license.expiryDate }})<br />
                Type: {{ d.type }}
              </p>
            </ng-container>
          </ng-container>
        </ng-container>
      </div>
    </div>
  

  
  <!-- KPI Cards below -->
<!-- Reorderable KPI Cards -->
<!-- Checkboxes (static, no drag here) -->
<div class="mb-4">
    <label class="me-3 fw-semibold">Select KPIs to display:</label>
    <label *ngFor="let kpi of kpis" class="me-3">
      <input type="checkbox" [(ngModel)]="kpi.visible" class="form-check-input me-1" />
      {{ kpi.label }}
    </label>
  </div>
  
  <!-- Drag-and-drop KPI Cards -->
<!-- Add this wrapper for DragDrop -->
<div
  cdkDropList
  [cdkDropListData]="kpis"
  class="d-flex flex-wrap gap-3"
  (cdkDropListDropped)="drop($event)"
>
    <ng-container *ngFor="let kpi of kpis; let i = index">
      <div *ngIf="kpi.visible" cdkDrag class="kpi-card">
        <div class="card border-0 shadow-sm h-100" style="width: 200px">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted fw-semibold text-uppercase">{{ kpi.label }}</small>
              <i *ngIf="kpi.trend === 'up'" class="bi bi-arrow-up text-success"></i>
              <i *ngIf="kpi.trend === 'down'" class="bi bi-arrow-down text-danger"></i>
            </div>
            <h5 class="fw-bold mt-2">{{ kpi.value }}</h5>
            <div class="progress mt-3" style="height: 5px;">
              <div
                class="progress-bar bg-primary"
                role="progressbar"
                [style.width]="kpi.trend === 'up' ? '75%' : '40%'"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
  
  
  
  
  
  
    <!-- Driver KPI History Chart -->
    <div class="row g-4 mb-4">
      <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="fw-semibold mb-0">Driver KPI Trends</h5>
              <div class="d-flex align-items-center">
                <label for="driverFilter" class="me-2 mb-0 text-muted small">Filter by Driver:</label>
                <select id="driverFilter" class="form-select form-select-sm w-auto" [(ngModel)]="selectedDriverId" (change)="updateChartOptions()">
                  <option value="">All Drivers</option>
                  <option *ngFor="let driver of driverKpiHistory" [value]="driver.id">
                    {{ driver.fullName }}
                  </option>
                </select>
              </div>
            </div>
            <app-chart-card [options]="efficiencyChartOptions" title="Driver KPI Trends"></app-chart-card>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Main Grid -->
    <div class="row g-4">
      <!-- Charts Left -->
      <div class="col-lg-8">
        <div class="mb-4">
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-semibold mb-0">Weekly Deliveries Trend</h5>
                <div>
                  <span class="badge bg-primary-subtle text-primary me-2">Completed</span>
                  <span class="badge bg-danger-subtle text-danger">Failed</span>
                </div>
              </div>
              <app-chart-card [options]="chartOptions"></app-chart-card>
            </div>
          </div>
  
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-semibold mb-0">Driver Efficiency Ratings</h5>
                <select class="form-select form-select-sm w-auto">
                  <option>This Week</option>
                  <option>Last Week</option>
                  <option>This Month</option>
                </select>
              </div>
              <app-chart-card [options]="barChartOptions"></app-chart-card>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Donut + Top Drivers -->
      <div class="col-lg-4">
      <!-- Delivery Punctuality -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-semibold mb-4">Delivery Punctuality</h5>
      <app-chart-card [options]="deliveryDonutChartOptions"></app-chart-card>
      <ul class="list-unstyled mt-4">
        <li *ngFor="let label of deliveryDonutChartOptions.labels; let i = index"
            class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center">
            <span class="me-2 d-inline-block rounded-circle" style="width:10px; height:10px;"
                  [ngStyle]="{ 'background-color': deliveryDonutChartOptions.colors[i] }"></span>
            <small class="text-muted">{{ label }}</small>
          </div>
          <small class="fw-medium">
            {{ deliveryDonutChartOptions.series[i] | number }}
            ({{ (deliveryDonutChartOptions.series[i] / sum(deliveryDonutChartOptions.series) * 100).toFixed(1) }}%)
          </small>
        </li>
      </ul>
    </div>
  </div>
  
        <!-- Top Performing Drivers -->
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="fw-semibold mb-0">Top Performing Drivers</h5>
              <a href="#" class="text-decoration-none text-primary small">View All</a>
            </div>
      
            <div *ngFor="let driver of topDrivers" class="d-flex align-items-center mb-3 p-2 rounded hover-bg-light">
              <div class="position-relative me-3">
                <img [src]="driver.avatar || 'https://ui-avatars.com/api/?name=' + driver.name.split(' ').join('+') + '&background=random'"
                  class="rounded-circle border" style="width: 48px; height: 48px; object-fit: cover" />
                <span *ngIf="driver.deliveries > 100"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">â˜…</span>
              </div>
              <div class="flex-grow-1">
                <div class="fw-semibold">{{ driver.name }}</div>
                <div class="text-muted small">{{ driver.deliveries }} deliveries</div>
              </div>
              <div class="d-flex align-items-center ms-2">
                <span class="badge bg-warning text-dark d-flex align-items-center px-2 py-1">
                  <i class="bi bi-star-fill me-1"></i> {{ driver.rating }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
  